name: CI

on:
  push:
  pull_request:

jobs:
  check-pr-diff:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全履歴を取得してdiffを正確に取得するため

      - name: Fetch base branch
        run: |
          # ベースブランチが指定されている場合はフェッチ
          if [ -n "${{ github.base_ref }}" ]; then
            git fetch origin ${{ github.base_ref }}:${{ github.base_ref }} || true
          fi

      - name: Show current branch info
        run: |
          echo "Current branch (HEAD): ${{ github.head_ref }}"
          echo "Base branch: ${{ github.base_ref }}"
          echo "PR number: ${{ github.event.pull_request.number }}"
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "Head SHA: ${{ github.event.pull_request.head.sha }}"

      - name: Show diff between base and head
        run: |
          # GitHub Actions環境ではPRのSHAを使用、act環境ではブランチ名を使用
          if [ -n "${{ github.event.pull_request.base.sha }}" ] && [ -n "${{ github.event.pull_request.head.sha }}" ]; then
            echo "=== Diff between ${{ github.base_ref }} (${{ github.event.pull_request.base.sha }}) and ${{ github.head_ref }} (${{ github.event.pull_request.head.sha }}) ==="
            echo ""
            echo "=== Diff Statistics ==="
            git diff --stat ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}
            echo ""
            echo "=== Full Diff ==="
            git --no-pager diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}
          else
            # act環境でのフォールバック: 現在のブランチとベースブランチのdiff
            BASE_BRANCH="${{ github.base_ref }}"
            # ベースブランチが空の場合はmainまたはmasterを試す
            if [ -z "$BASE_BRANCH" ]; then
              if git show-ref --verify --quiet refs/heads/main || git show-ref --verify --quiet refs/remotes/origin/main; then
                BASE_BRANCH="main"
              else
                BASE_BRANCH="master"
              fi
            fi
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "=== Diff between $BASE_BRANCH and $CURRENT_BRANCH (act環境) ==="
            git fetch origin $BASE_BRANCH:$BASE_BRANCH 2>/dev/null || true
            
            if git show-ref --verify --quiet refs/heads/$BASE_BRANCH; then
              echo ""
              echo "=== Diff Statistics ==="
              git diff --stat $BASE_BRANCH...HEAD
              echo ""
              echo "=== Full Diff ==="
              git --no-pager diff $BASE_BRANCH...HEAD
            elif git show-ref --verify --quiet refs/remotes/origin/$BASE_BRANCH; then
              echo ""
              echo "=== Diff Statistics ==="
              git diff --stat origin/$BASE_BRANCH...HEAD
              echo ""
              echo "=== Full Diff ==="
              git --no-pager diff origin/$BASE_BRANCH...HEAD
            else
              echo "ベースブランチ $BASE_BRANCH が見つかりませんでした"
            fi
          fi